# 表格转换工具（Table Transform Tool）方案文档

## 1. 概述

### 1.1 背景

在数据分析场景中，用户经常需要对数据表进行各种转换操作，如插入列、删除列、数据透视（pivot）、行列转换（melt）等。现有的 `analyze_data` 工具主要面向数据分析查询，返回分析结果但不会修改原始数据。

为了满足用户对数据表进行"编辑式"操作的需求，我们新增 **表格转换工具（transform_table）**，支持用户通过自然语言指令对数据表进行各种转换操作，并将结果保存为新文件。

### 1.2 设计目标

| 目标 | 说明 |
|------|------|
| **功能完整** | 支持常见的 pandas 表操作，覆盖列操作、行操作、数据重塑、分组聚合、数据清洗等场景 |
| **数据安全** | 不覆盖原始文件，使用步骤编号生成新文件名，保留完整的操作历史 |
| **智能纠错** | 代码执行失败时自动重试并修正错误，最大程度保证执行成功 |
| **架构一致** | 与现有 `analyze_data` 工具保持一致的代码风格和架构模式 |

---

## 2. 功能设计

### 2.1 核心功能

#### 2.1.1 transform_table - 表格转换

对数据表执行转换操作，支持以下操作类型：

| 操作类别 | 具体操作 | 示例指令 |
|---------|---------|---------|
| **列操作** | 插入新列 | "新增一列profit，值为revenue减去cost" |
| | 删除列 | "删除备注列" |
| | 重命名列 | "将name列重命名为姓名" |
| | 调整列顺序 | "将id列移动到第一列" |
| | 修改数据类型 | "将price列转换为浮点数类型" |
| **行操作** | 筛选行 | "保留销售额大于1000的记录" |
| | 删除重复行 | "按订单号去重" |
| | 排序 | "按日期降序排列" |
| | 采样 | "随机抽取100条记录" |
| **数据重塑** | 行转列（pivot） | "以产品为行，月份为列，销售额为值做透视" |
| | 列转行（melt） | "将Q1~Q4四列转换为季度和销售额两列" |
| | 透视表 | "按地区和产品分组，计算销售额的总和和平均值" |
| **分组聚合** | groupby | "按部门统计人数和平均工资" |
| | 窗口函数 | "计算每个用户的累计消费金额" |
| **数据清洗** | 处理缺失值 | "将空值填充为0" |
| | 处理异常值 | "删除价格为负数的记录" |
| | 字符串处理 | "将姓名列去除前后空格" |
| | 日期处理 | "从日期列提取年份和月份" |

#### 2.1.2 get_transform_steps - 查看转换历史

查看某个文件的所有步骤版本，方便用户追踪和管理转换历史。

### 2.2 文件命名规则

为避免覆盖原始文件，采用 **步骤编号命名** 方式：

```
原始文件：data.xlsx
├── 第1步：data_step_1.xlsx
├── 第2步：data_step_2.xlsx
├── 第3步：data_step_3.xlsx
└── ...
```

**命名格式**：`{原文件名}_step_{步骤编号}.{扩展名}`

---

## 3. 技术实现

### 3.1 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    pandas_mcp_server.py                      │
│                       (MCP服务入口)                          │
├─────────────────────────────────────────────────────────────┤
│  transform_table()          │  get_transform_steps()         │
│  ├── 参数校验               │  ├── 扫描目录                  │
│  ├── 生成输出路径           │  └── 返回步骤列表              │
│  ├── 调用代码生成器         │                                │
│  ├── 调用代码执行器         │                                │
│  └── 返回结果               │                                │
└─────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            ▼                 ▼                 ▼
┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
│ TableTransform    │ │ TableTransform    │ │   DataAccessor    │
│   Generator       │ │   Executor        │ │   (Excel/CSV)     │
├───────────────────┤ ├───────────────────┤ ├───────────────────┤
│ • 加载提示词模板  │ │ • 执行生成的代码  │ │ • 加载数据文件    │
│ • 构建完整提示词  │ │ • 错误重试机制    │ │ • 获取数据摘要    │
│ • 调用LLM生成代码 │ │ • 调用错误修正器  │ │ • 提供DataFrame   │
│ • 提取Python代码  │ │ • 保存结果文件    │ │                   │
└───────────────────┘ └───────────────────┘ └───────────────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │ TableTransform    │
                    │ ErrorCorrector    │
                    ├───────────────────┤
                    │ • 加载纠错提示词  │
                    │ • 构建错误历史    │
                    │ • 调用LLM修正代码 │
                    └───────────────────┘
```

### 3.2 新增文件清单

| 文件路径 | 说明 |
|---------|------|
| `src/code_generators/table_transform_generator.py` | 表格转换代码生成器 |
| `src/table_transform_executor.py` | 代码执行器 + 错误纠正器 |
| `data/prompts/code_gen/python/table_transform_v1.md` | 代码生成提示词 |
| `data/prompts/code_error_correction/python/table_transform_v1.md` | 错误纠正提示词 |

### 3.3 核心代码说明

#### 3.3.1 代码生成器

```python
class TableTransformGenerator:
    def generate_code(self, instruction: str, output_path: str) -> str:
        """
        根据用户指令生成表格转换代码
        
        Args:
            instruction: 用户的操作指令
            output_path: 输出文件路径
            
        Returns:
            生成的Python代码
        """
```

#### 3.3.2 代码执行器

```python
class TableTransformExecutor:
    def execute(self, instruction: str, code: str, output_path: str) -> pd.DataFrame:
        """
        执行表格转换代码，支持自动错误修正
        
        - 最大重试次数由配置文件控制
        - 执行失败时自动调用错误纠正器修正代码
        """
```

#### 3.3.3 LLM生成的代码模板

```python
import pandas as pd

def transform(df: pd.DataFrame, output_path: str) -> pd.DataFrame:
    """
    对输入的DataFrame进行转换操作，并保存到指定路径
    
    Args:
        df: 输入的DataFrame
        output_path: 输出文件路径
        
    Returns:
        转换后的DataFrame
    """
    # LLM 在此处填充转换逻辑
    result = df  
    
    # 保存结果
    if output_path.lower().endswith('.xlsx'):
        result.to_excel(output_path, index=False)
    elif output_path.lower().endswith('.csv'):
        result.to_csv(output_path, index=False, encoding='utf-8-sig')
    
    return result
```

---

## 4. 提示词设计

### 4.1 代码生成提示词要点

1. **角色设定**：精通 Pandas 的数据工程师
2. **任务说明**：根据操作指令对数据表进行转换并保存
3. **操作类型列举**：列出支持的操作类型，帮助 LLM 理解可行操作范围
4. **代码模板**：提供 `transform(df, output_path)` 函数签名
5. **数据信息**：提供列名、数据类型、典型取值、最大最小值等
6. **约束条件**：
   - 保持数据完整性
   - 处理边界情况
   - 代码简洁高效
   - 禁止使用绘图库

### 4.2 错误纠正提示词要点

1. **常见错误类型**：
   - `KeyError`：列名不存在
   - `TypeError`：数据类型不匹配
   - `ValueError`：pivot 时重复值
   - `FileNotFoundError`：保存路径不存在
2. **错误历史**：提供之前的代码和对应的报错信息
3. **修复建议**：针对常见错误提供修复思路

---

## 5. 使用示例

### 5.1 基础使用

**场景**：在销售数据表中新增利润率列

```
用户输入：
在这个销售表中新增一列"利润率"，计算公式是(销售额-成本)/销售额*100，保留两位小数

AI 调用：
transform_table(
    instruction="新增一列'利润率'，值为(销售额-成本)/销售额*100，保留两位小数",
    path_or_url="data/sales.xlsx",
    step=1
)

执行结果：
✅ 转换完成
- 保存路径: data/sales_step_1.xlsx
- 总行数: 1000
- 新增列: 利润率
```

### 5.2 数据透视

**场景**：将月度数据转换为透视表

```
用户输入：
把这个表做个透视，产品名称作为行，月份作为列，销售额作为值，显示每个产品每月的销售总额

AI 调用：
transform_table(
    instruction="pivot操作，index为产品名称，columns为月份，values为销售额，aggfunc为sum",
    path_or_url="data/sales_step_1.xlsx",
    step=2
)

执行结果：
✅ 转换完成
- 保存路径: data/sales_step_2.xlsx
- 行数: 50 (产品数)
- 列数: 13 (产品名称 + 12个月)
```

### 5.3 查看转换历史

```
用户输入：
看看这个文件有哪些步骤版本

AI 调用：
get_transform_steps(path_or_url="data/sales.xlsx")

执行结果：
## sales.xlsx 的步骤版本文件

| 步骤 | 文件名 | 文件大小 |
|------|--------|----------|
| - | sales_step_1.xlsx | 125.3 KB |
| - | sales_step_2.xlsx | 48.7 KB |
```

---

## 6. 配置说明

在 `config.yaml` 中可配置以下参数：

```yaml
# 代码执行最大重试次数（错误自动修正）
max_retry_execution_count: 3
```

---

## 7. 与现有工具对比

| 特性 | analyze_data | transform_table |
|------|--------------|-----------------|
| **用途** | 数据分析查询 | 数据表转换编辑 |
| **返回值** | 分析结果（DataFrame） | 转换后的表格 |
| **是否保存** | ❌ 不保存 | ✅ 保存为新文件 |
| **文件覆盖** | - | ❌ 使用步骤编号，不覆盖 |
| **典型场景** | "销售额最高的前10个产品" | "新增利润率列" |

---

## 8. 后续优化方向

1. **支持多表操作**：支持两个表的 merge/join 操作
2. **操作撤销**：支持回退到上一个步骤版本
3. **批量操作**：支持在一次调用中执行多个转换操作
4. **操作记录**：记录每个步骤的操作指令，方便追溯
5. **预览模式**：在执行前预览转换效果，确认后再保存

---

## 9. 总结

表格转换工具（transform_table）是对现有数据分析能力的重要补充，使用户能够通过自然语言指令直接对数据表进行编辑操作。通过步骤编号的文件命名机制，既保证了数据安全，又方便用户追踪操作历史。结合智能错误修正机制，最大程度保证操作的成功率。

